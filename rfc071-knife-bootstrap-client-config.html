<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable = no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation-essential/6.2.2/css/foundation.min.css">
    <style>
      a { color: #f18b21; }
      a:hover, a:focus { color: #3f5364; }
    </style>
    <title>Chef RFCs</title>
  </head>
  <body>
    <div class="row medium-12 columns">
      <header class="clearfix">
        <div class="left">
          <a href="/chef-rfc"><h1>Chef RFCs</h1></a>
        </div>
      </header>
<h1>Knife Bootstrap <code>client.rb</code> Configuration</h1>

<p>Knife bootstrap currently only allows a select few <code>client.rb</code> parameters
to be specified during bootstrap. This RFC proposes a solution to allow users
to pass bulk configuration data to <code>knife bootstrap</code> to be placed in the
<code>client.rb</code> before the first chef-client run.</p>

<h2>Background</h2>

<p>The <code>knife bootstrap</code> command supports a small subset of possible parameters
a user can configure in the <code>client.rb</code>. The chef-client cookbook provides a
template that supports many more, allowing the user to configure additional
options during a Chef client converge. If something you are trying to do does
not fit into the template provided, you are also free to specify config files
in a <code>client.d</code> folder that will automatically be loaded. However, because
the chef-client cookbook is run along with the rest of the run list on the
first run, your settings do not take effect until the second chef-client
run.</p>

<h2>Motivation</h2>
<div class="highlight"><pre><span></span>As a Chef user,
I want to be able to configure chef-client with options that aren&#39;t supported by knife bootstrap,
so that I do not have to maintain a fork of the bootstrap template,
or so that I do not have to learn about bootstrap templates at all,
or so that I don&#39;t have to make two chef-client runs on bootstrap to apply and use my configuration file.

As a Chef developer,
I want the user to have a generic way to pass custom client configuration file,
so that I don&#39;t have the maintenance cost of additional bootstrap arguments for new features
</pre></div>
<h2>Specification</h2>

<h3>Append Config Files From <code>client.d</code></h3>

<p>The <code>chef-client</code> cookbook adds a block to load all <code>.rb</code> files in
the <code>client.d</code> folder. The proposal here is to do the same thing.
Knife bootstrap will take a <code>client.d</code> folder, by default looking
the chef repo under <code>bootstrap</code>, optionally overwritable with a
<code>knife.rb</code> configuration parameter <code>client_d_path</code>. The files
will be loaded in alphabetical order. Knife will still sync all files
under <code>client.d</code>, however only top-level files will the automatically
loaded. The block to do this would look something like:</p>
<div class="highlight"><pre><span></span><span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;/etc/chef/client.d/*.rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">conf</span><span class="o">|</span>
  <span class="no">Chef</span><span class="o">::</span><span class="no">Config</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
<h4>Example</h4>

<p>For this example, consider we want to configure Ohai&#39;s hostname plugin.
The execution of this plugin will determine the node name that will be
assigned to the node we are bootstraping, so it needs to be correct on
the first run.</p>

<p>We store the <code>ohai_config.rb</code> file in the Chef repo on our workstation:</p>
<div class="highlight"><pre><span></span><span class="c1"># chef-repo/bootstrap/client.d/ohai_config.rb</span>

<span class="n">ohai</span><span class="o">.</span><span class="n">plugin</span><span class="o">[</span><span class="ss">:hostname</span><span class="o">][</span><span class="ss">:fqdn_using</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span> <span class="ss">:hostname</span><span class="p">,</span> <span class="ss">:nis</span><span class="p">,</span> <span class="ss">:dns</span> <span class="o">]</span>
</pre></div><div class="highlight"><pre><span></span><span class="c1"># chef-repo/bootstrap/client.d/ohai_plugins/custom_plugin.rb</span>

<span class="c1"># My custom ohai plugin</span>
</pre></div>
<p>Next we bootstrap the node:</p>
<div class="highlight"><pre><span></span>knife bootstrap 10.0.0.100 -x chefuser -P oneofus
</pre></div>
<p>This generates the following <code>client.rb</code> and copies it to the box,
along with all the contents in our chef repo&#39;s <code>client.d</code> directory:</p>
<div class="highlight"><pre><span></span><span class="c1"># /etc/chef/client.rb</span>

<span class="n">log_level</span>        <span class="ss">:info</span>
<span class="n">log_location</span>     <span class="no">STDOUT</span>
<span class="n">chef_server_url</span>  <span class="s2">&quot;https://api.chef.io/organizations/oneofus&quot;</span>
<span class="n">ohai</span><span class="o">.</span><span class="n">plugin_path</span> <span class="o">=</span> <span class="s2">&quot;/etc/chef/client.d/ohai_plugins&quot;</span>

<span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;/etc/chef/client.d/*.rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">conf</span><span class="o">|</span>
  <span class="no">Chef</span><span class="o">::</span><span class="no">Config</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
<span class="k">end</span>
</pre></div><div class="highlight"><pre><span></span><span class="c1"># /etc/chef/client.d/ohai_config.rb</span>

<span class="n">ohai</span><span class="o">.</span><span class="n">plugin</span><span class="o">[</span><span class="ss">:hostname</span><span class="o">][</span><span class="ss">:fqdn_using</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span> <span class="ss">:hostname</span><span class="p">,</span> <span class="ss">:nis</span><span class="p">,</span> <span class="ss">:dns</span> <span class="o">]</span>
</pre></div><div class="highlight"><pre><span></span><span class="c1"># /etc/chef/client.d/ohai_plugins/custom_plugin.rb</span>

<span class="c1"># My custom ohai plugin</span>
</pre></div>
<p>Now, when chef-client runs on the box, our configurations to
Ohai&#39;s hostname plugin will be loaded before Ohai runs, allowing
the first Chef run to get the correct hostname.</p>

<p>Taking a look under <code>/etc/chef</code>, we should see something like:</p>
<div class="highlight"><pre><span></span>[vagrant@localhost ~]$ tree /etc/chef/
/etc/chef/
├── client.d
│   ├── ohai_config.rb
│   └── ohai_plugins
│       └── custom_plugin.rb
├── client.pem
├── client.rb
├── first-boot.json
├── trusted_certs
│   └── localhost.crt
└── validation.pem
</pre></div>
<h2>Copyright</h2>

<p>This work is in the public domain. In jurisdictions that do not allow for this,
this work is available under CC0. To the extent possible under law, the person
who associated CC0 with this work has waived all copyright and related or
neighboring rights to this work.</p>
    </div>
  </body>
</html>
