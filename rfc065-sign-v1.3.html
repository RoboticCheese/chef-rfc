<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable = no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation-essential/6.2.2/css/foundation.min.css">
    <style>
      a { color: #f18b21; }
      a:hover, a:focus { color: #3f5364; }
    </style>
    <title>Chef RFCs</title>
  </head>
  <body>
    <div class="row medium-12 columns">
      <header class="clearfix">
        <div class="left">
          <a href="/chef-rfc"><h1>Chef RFCs</h1></a>
        </div>
      </header>
<h1>Chef Authentication Signing Protocol v1.3</h1>

<p>The current Chef signing protocols force users to use SHA1 based algorithms. This RFC proposes a new signing protocol which uses methods approved in <a href="http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-131Ar1.pdf">NIST.SP.800</a> for digital signatures.</p>

<h2>Background</h2>

<p>The Chef Server currently supports 3 different signing protocols: v1.0, v1.1, and v1.2. All of these protocols use a RSA private key to sign a message, which is verified by the server using the public key. Once a signature is created and Base64 encoded, it is broken up into lines of no more than 60 characters and placed into the <code>X-Ops-Authorization-1</code>, <code>X-Ops-Authorization-2</code>, ..., <code>X-Ops-Authorization-N</code> headers.</p>

<h3>Signing Protocol v1.0</h3>

<p>Signing protocol v1.0 signs the following message:</p>
<div class="highlight"><pre><span></span><span class="n">Method</span><span class="o">:</span><span class="n">HTTP_METHOD</span>
<span class="n">Hashed</span> <span class="n">Path</span><span class="o">:</span><span class="n">HASHED_PATH</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Content</span><span class="o">-</span><span class="n">Hash</span><span class="o">:</span><span class="n">HASHED_BODY</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Timestamp</span><span class="o">:</span><span class="n">TIME</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">UserId</span><span class="o">:</span><span class="n">USERID</span>
</pre></div>
<p>where:
  - <code>HTTP_METHOD</code> is the method used in the API request
  - <code>HASHED_PATH</code> is the path of the request: <code>/organizations/NAME/name_of_endpoint</code>. The <code>HASHED_PATH</code> must be hashed using SHA1 and encoded using Base64, must not have repeated forward slashes (<code>/</code>), must not end in a forward slash (unless the path is <code>/</code>), and must not include a query string.
  - <code>HASHED_BODY</code> is the Base64 encoded value of the SHA1 hash of the request body
  - <code>TIME</code> is the timestamp in ISO-8601 format and with UTC indicated by a trailing <code>Z</code> and separated by the character <code>T</code>. For example: <code>2013-03-10T14:14:44Z</code>.
  - <code>USERID</code> is the user id, for example the client name</p>

<p>This message is encrypted with the users(or nodes) RSA private key. The server verifies the message by recreating the message using the provided headers and decrypting it using the users public key.</p>

<p>v1.0 is the default version used by Chef Client as of version 12.5.1. However, v1.0 fails when the client name is longer that ~90 characters, so chef client will switch to the v1.1 protocol.</p>

<h3>Signing Protocol v1.1</h3>

<p>Signing protocol v1.1 was introduced to support longer client names. It is almost identical to v1.0, except <code>USERID</code> is now a SHA1 hash of the user id.</p>

<h3>Signing Protocol v1.2</h3>

<p>Signing protocol v1.2 signs the same message as v1.1. The signing, however, is slightly different. The motivation behind v1.2 was to use a standardized signing scheme. v1.2 uses the <code>RSASSA-PKCS1-v1_5</code> signature scheme to sign the message. The hashing algorithm used by the scheme is SHA1. More information about the <code>RSASSA-PKCS1-v1_5</code> can be found in the <a href="https://www.emc.com/collateral/white-papers/h11300-pkcs-1v2-2-rsa-cryptography-standard-wp.pdf">PKCS#1 v2.2 RSA Cryptography Standard</a> document.</p>

<h2>Motivation</h2>

<p>The current signing algorithms used for authentication with the Chef Server are not covered under those which are approved by the NIST.SP.800 guidelines. Chef users working with the U.S. government are often required to ensure their infrastructure meets certain security requirements, including those for cryptographic algorithms as specified in <a href="http://csrc.nist.gov/publications/fips/fips140-2/fips1402.pdf">FIPS 140-2</a>. The SHA-1 algorithm currently used for authentication with the Chef Server is not approved for use in digital signature generation per <a href="http://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-131Ar1.pdf">NIST SP 800-131A</a>, thus preventing those users from using Chef in their environments.</p>

<p>The current signing algorithms are also vulnerable to replay attacks by changing the <code>X-Ops-Server-API-Version</code>. Since this header is not covered under the authenticated message, the request could be replayed with a different version, changing the effect the request has.</p>

<h2>Specification</h2>

<h3>v1.3 Message Format</h3>

<p>Following is the message to be signed by the v1.3 protocol.</p>
<div class="highlight"><pre><span></span><span class="n">Method</span><span class="o">:</span><span class="n">HTTP_METHOD</span>
<span class="n">Path</span><span class="o">:</span><span class="n">PATH</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Content</span><span class="o">-</span><span class="n">Hash</span><span class="o">:</span><span class="n">HASHED_BODY</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Sign</span><span class="o">:</span><span class="n">version</span><span class="o">=</span><span class="mf">1.3</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Timestamp</span><span class="o">:</span><span class="n">TIME</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">UserId</span><span class="o">:</span><span class="n">USERID</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Server</span><span class="o">-</span><span class="n">API</span><span class="o">-</span><span class="n">Version</span><span class="o">:</span><span class="n">HEADER_X_OPS_SERVER_API_VERSION</span>
</pre></div>
<p>where:
  - <code>PROTOCOL_VERSION</code> is the signing protocol that will be used.
  - <code>HTTP_METHOD</code> is the method used in the HTTP request. It should be all upper case (<code>POST</code>, <code>GET</code>, <code>PUT</code>, etc)
  - <code>PATH</code> us a canonicalized representation of the path. This path must not have repeated forward slashes (<code>/</code>), must not end in a forward slash (unless the path is <code>/</code>), and must not include a query string.
  - <code>HASHED_BODY</code> is the Base64 encoded value of <code>Hash(SHA256, Body)</code>
  - <code>TIME</code> is the timestamp in ISO-8601 format and with UTC indicated by a trailing <code>Z</code> and separated by the character <code>T</code>. For example: <code>2013-03-10T14:14:44Z</code>.
  - <code>USERID</code> is the user id, for example the client name
  - <code>HEADER_X_OPS_SERVER_API_VERSION</code> is the value of <code>X-Ops-Server-API-Version</code> passed to the Chef server.</p>

<p>There is a new line character(<code>\n</code>) after each line in this message <strong>except the last line</strong>.</p>

<h3>v1.3 Signing Protocol</h3>

<p>Signing protocol v1.3 signs message format v1.3 messages using the <code>RSASSA-PKCS1-v1_5</code> signature scheme as described in <a href="https://www.emc.com/collateral/white-papers/h11300-pkcs-1v2-2-rsa-cryptography-standard-wp.pdf">PKCS#1 v2.2 RSA Cryptography Standard</a>. v1.3 will use SHA256 as the hashing algorithm.</p>

<p>This protocol is very similar to v1.2. The signing scheme is the same (RSASSA-PKCS1-v1_5). The message format signs a few additional pieces of information: The signing protocol version, the hashing algorithm to be used, and the <code>X-Ops-Server-API-Version</code> header.</p>

<h3>Example</h3>

<p>The following is an example of how to go from the information required to make a signature to the actual signature. First, an RSA key (private_key.pem):</p>
<div class="highlight"><pre><span></span>-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA0ueqo76MXuP6XqZBILFziH/9AI7C6PaN5W0dSvkr9yInyGHS
z/IR1+4tqvP2qlfKVKI4CP6BFH251Ft9qMUBuAsnlAVQ1z0exDtIFFOyQCdR7iXm
jBIWMSS4buBwRQXwDK7id1OxtU23qVJv+xwEV0IzaaSJmaGLIbvRBD+qatfUuQJB
MU/04DdJIwvLtZBYdC2219m5dUBQaa4bimL+YN9EcsDzD9h9UxQo5ReK7b3cNMzJ
BKJWLzFBcJuePMzAnLFktr/RufX4wpXe6XJxoVPaHo72GorLkwnQ0HYMTY8rehT4
mDi1FI969LHCFFaFHSAaRnwdXaQkJmSfcxzCYQIDAQABAoIBAQCW3I4sKN5B9jOe
xq/pkeWBq4OvhW8Ys1yW0zFT8t6nHbB1XrwscQygd8gE9BPqj3e0iIEqtdphbPmj
VHqTYbC0FI6QDClifV7noTwTBjeIOlgZ0NSUN0/WgVzIOxUz2mZ2vBZUovKILPqG
TOi7J7RXMoySMdcXpP1f+PgvYNcnKsT72UcWaSXEV8/zo+Zm/qdGPVWwJonri5Mp
DVm5EQSENBiRyt028rU6ElXORNmoQpVjDVqZ1gipzXkifdjGyENw2rt4V/iKYD7V
5iqXOsvP6Cemf4gbrjunAgDG08S00kiUgvVWcdXW+dlsR2nCvH4DOEe3AYYh/aH8
DxEE7FbtAoGBAPcNO8fJ56mNw0ow4Qg38C+Zss/afhBOCfX4O/SZKv/roRn5+gRM
KRJYSVXNnsjPI1plzqR4OCyOrjAhtuvL4a0DinDzf1+fiztyNohwYsW1vYmqn3ti
EN0GhSgE7ppZjqvLQ3f3LUTxynhA0U+k9wflb4irIlViTUlCsOPkrNJDAoGBANqL
Q+vvuGSsmRLU/Cenjy+Mjj6+QENg51dz34o8JKuVKIPKU8pNnyeLa5fat0qD2MHm
OB9opeQOcw0dStodxr6DB3wi83bpjeU6BWUGITNiWEaZEBrQ0aiqNJJKrrHm8fAZ
9o4l4oHc4hI0kYVYYDuxtKuVJrzZiEapTwoOcYiLAoGBAI/EWbeIHZIj9zOjgjEA
LHvm25HtulLOtyk2jd1njQhlHNk7CW2azIPqcLLH99EwCYi/miNH+pijZ2aHGCXb
/bZrSxM0ADmrZKDxdB6uGCyp+GS2sBxjEyEsfCyvwhJ8b3Q100tqwiNO+d5FCglp
HICx2dgUjuRVUliBwOK93nx1AoGAUI8RhIEjOYkeDAESyhNMBr0LGjnLOosX+/as
qiotYkpjWuFULbibOFp+WMW41vDvD9qrSXir3fstkeIAW5KqVkO6mJnRoT3Knnra
zjiKOITCAZQeiaP8BO5o3pxE9TMqb9VCO3ffnPstIoTaN4syPg7tiGo8k1SklVeH
2S8lzq0CgYAKG2fljIYWQvGH628rp4ZcXS4hWmYohOxsnl1YrszbJ+hzR+IQOhGl
YlkUQYXhy9JixmUUKtH+NXkKX7Lyc8XYw5ETr7JBT3ifs+G7HruDjVG78EJVojbd
8uLA+DdQm5mg4vd1GTiSK65q/3EeoBlUaVor3HhLFki+i9qpT8CBsg==
-----END RSA PRIVATE KEY-----
</pre></div>
<p>For this example, assume the following intent:</p>

<p>|key                 |value                   |
|--------------------|------------------------|
| Http Method        | POST                   |
| Path               | /organizations/clownco |
| Body               | Spec Body              |
| Timestamp          | 2009-01-01T12:00:00Z   |
| User               | spec-user              |
| Server Api Version | 1                      |
| Sign Protocol      | v1.3                   |</p>

<p>Using this information, we can generate the following message:</p>
<div class="highlight"><pre><span></span><span class="n">Method</span><span class="o">:</span><span class="n">POST</span>
<span class="n">Path</span><span class="o">:/</span><span class="n">organizations</span><span class="o">/</span><span class="n">clownco</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Content</span><span class="o">-</span><span class="n">Hash</span><span class="o">:</span><span class="n">hDlKNZhIhgso3Fs0S0pZwJ0xyBWtR1RBaeHs1DrzOho</span><span class="o">=</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Sign</span><span class="o">:</span><span class="n">version</span><span class="o">=</span><span class="mf">1.3</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Timestamp</span><span class="o">:</span><span class="mi">2009</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="n">T12</span><span class="o">:</span><span class="mi">00</span><span class="o">:</span><span class="mi">00</span><span class="n">Z</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">UserId</span><span class="o">:</span><span class="n">spec</span><span class="o">-</span><span class="n">user</span>
<span class="n">X</span><span class="o">-</span><span class="n">Ops</span><span class="o">-</span><span class="n">Server</span><span class="o">-</span><span class="n">API</span><span class="o">-</span><span class="n">Version</span><span class="o">:</span><span class="mi">1</span>
</pre></div>
<p>Note the line endings are <code>\n</code>, and there is no newline character after <code>X-Ops-Server-API-Version:1</code>.</p>

<p>This message can now be signed, with the expected Base64 representation being:</p>
<div class="highlight"><pre><span></span>FZOmXAyOBAZQV/uw188iBljBJXOm+m8xQ/8KTGLkgGwZNcRFxk1m953XjE3W
VGy1dFT76KeaNWmPCNtDmprfH2na5UZFtfLIKrPv7xm80V+lzEzTd9WBwsfP
42dZ9N+V9I5SVfcL/lWrrlpdybfceJC5jOcP5tzfJXWUITwb6Z3Erg3DU3Uh
H9h9E0qWlYGqmiNCVrBnpe6Si1gU/Jl+rXlRSNbLJ4GlArAPuL976iTYJTzE
MmbLUIm3JRYi00Yb01IUCCKdI90vUq1HHNtlTEu93YZfQaJwRxXlGkCNwIJe
fy49QzaCIEu1XiOx5Jn+4GmkrZch/RrK9VzQWXgs+w==
</pre></div>
<p>The Chef server should expect the following headers to be passed along:</p>

<p>| name                  | value                                                        |
|-----------------------|--------------------------------------------------------------|
| X-Ops-Authorization-1 | FZOmXAyOBAZQV/uw188iBljBJXOm+m8xQ/8KTGLkgGwZNcRFxk1m953XjE3W |
| X-Ops-Authorization-2 | VGy1dFT76KeaNWmPCNtDmprfH2na5UZFtfLIKrPv7xm80V+lzEzTd9WBwsfP |
| X-Ops-Authorization-3 | 42dZ9N+V9I5SVfcL/lWrrlpdybfceJC5jOcP5tzfJXWUITwb6Z3Erg3DU3Uh |
| X-Ops-Authorization-4 | H9h9E0qWlYGqmiNCVrBnpe6Si1gU/Jl+rXlRSNbLJ4GlArAPuL976iTYJTzE |
| X-Ops-Authorization-5 | MmbLUIm3JRYi00Yb01IUCCKdI90vUq1HHNtlTEu93YZfQaJwRxXlGkCNwIJe |
| X-Ops-Authorization-6 | fy49QzaCIEu1XiOx5Jn+4GmkrZch/RrK9VzQWXgs+w==                 |</p>

<h2>Compatibility</h2>

<p>The Chef server currently returns the supported protocol versions when failing to authenticate. This information is returned in the <code>WWW-Authenticate</code> header of the response along with a response code of <code>401</code>. An example of a value that is returned that header is <code>X-Ops-Sign version=&quot;1.0&quot; version=&quot;1.1&quot;</code>, with a  response body of <code>{&quot;error&quot;:[&quot;Invalid signature for user or client &#39;foo&#39;&quot;]}</code>. The response provides no information as to why the authentication failed.</p>

<h2>Copyright</h2>

<p>This work is in the public domain. In jurisdictions that do not allow for this, this work is available under CC0. To the extent possible under law, the person who associated CC0 with this work has waived all copyright and related or neighboring rights to this work.</p>
    </div>
  </body>
</html>
