<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable = no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation-essential/6.2.2/css/foundation.min.css">
    <style>
      a { color: #f18b21; }
      a:hover, a:focus { color: #3f5364; }
    </style>
    <title>Chef RFCs</title>
  </head>
  <body>
    <div class="row medium-12 columns">
      <header class="clearfix">
        <div class="left">
          <a href="/chef-rfc"><h1>Chef RFCs</h1></a>
        </div>
      </header>
<h1>Chef telemetry</h1>

<h2>Motivation</h2>

<p>As a chef user and developer
  I want an easy way to get chef run performance data
  so that I can identify areas that can be optimized</p>

<p>As we automate more things with chef and control more system resources,
chef run time increases, and the chef client process consumes more memory and cpu.
As a configuration management system, it is important that a chef run
does not impact the underlying host performance. Over the last few years
Chef community has shared a number of optimization techniques. Aim of this
RFC is to facilitate some of those common patterns by providing a robust
telemetry system in core chef. If configured, the telemetry system will give users fine
grained metrics about chef run that can be used to find out
performance hiccups. This will also help users quantify how a chef
run impacts the underlying system.</p>

<h2>Specification</h2>

<p>Telemetry module will provide following metrics:</p>

<ul>
<li><p>Time spent on key chef run milestones: How long does the chef run take for each stage? Telemetry system
will declare  a subset of the current events as major milestones, these are: run<em>start,
ohai</em>completed, node<em>load</em>completed, cookbook<em>resolution</em>complete, converge<em>start,
converge</em>complete, run_completed/failed. Metrics will be captured during these milestones via event handlers.
This can be used to estimate time spent on cookbook sync, compilation
convergence phase etc.</p></li>
<li><p>Time spent on individual resource &amp; recipe convergence. This information is already available
using the API, telemetry system will just consolidate them, along side the other metrics.</p></li>
<li><p>GC related data. Ruby&#39;s internal memory usage obtained from
GC.stat, captured during the chef run milestones.</p></li>
</ul>

<p>Telemetry system will also let users define their custom metrics that can be computed
during these milestones (like total chef client process memory consumption from /proc/PID),
This will be offered via Chef class DSL. This will also be the recommended way to implement platform
specific metrics. Example:</p>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">&#39;sys/proctable&#39;</span>

<span class="no">Chef</span><span class="o">.</span><span class="n">telemetry</span> <span class="k">do</span> <span class="o">|</span><span class="n">telemetry</span><span class="o">|</span>
  <span class="n">telemetry</span><span class="o">.</span><span class="n">add_metric</span> <span class="s1">&#39;vsize&#39;</span> <span class="k">do</span>
    <span class="no">Sys</span><span class="o">::</span><span class="no">ProcTable</span><span class="o">.</span><span class="n">ps</span><span class="p">(</span><span class="no">Process</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span><span class="o">.</span><span class="n">vsize</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
<p>In addition to capturing these metrics, telemetry system will also provide publishing
API for metrics. Telemetry system will provide two publishing mechanism out of the box.
They are
  - node attributes: metrics will be saved as node attribute itself
  - statsd : To publish metrics via statsd endpoints</p>

<p>Telemetry system can be configured via the standard chef config file or using a dedicated
CLI flag for chef-client and chef-solo. It will be disabled by default.
Following is an example of configuring the telemetry subsystem</p>
<div class="highlight"><pre><span></span><span class="n">enable_telemetry</span> <span class="kp">true</span>

<span class="n">config_context</span><span class="p">(</span><span class="ss">:telemetry</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">resource</span> <span class="kp">true</span> <span class="c1"># captures per resource execution time taken</span>
  <span class="n">recipe</span> <span class="kp">true</span> <span class="c1"># captures per recipe execution time taken</span>
  <span class="n">gc</span> <span class="kp">true</span> <span class="c1"># captures GC stats during main chef events</span>
  <span class="n">process</span> <span class="kp">true</span>  <span class="c1"># captures process memroy stats from /proc during main chef events</span>
  <span class="n">client_run</span> <span class="kp">true</span> <span class="c1"># captures time spent on major chef run milstones</span>
  <span class="n">publish_using</span><span class="p">(</span>
   <span class="no">Chef</span><span class="o">::</span><span class="no">Telemetry</span><span class="o">::</span><span class="no">Publisher</span><span class="o">::</span><span class="no">Statsd</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">host</span><span class="p">:</span> <span class="s1">&#39;192.168.2.11&#39;</span><span class="p">,</span> <span class="ss">port</span><span class="p">:</span> <span class="mi">7676</span><span class="p">),</span> <span class="c1"># emit data to statsd</span>
   <span class="no">Chef</span><span class="o">::</span><span class="no">Telemetry</span><span class="o">::</span><span class="no">Publisher</span><span class="o">::</span><span class="no">NodeAttribute</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;chef-metrics&#39;</span><span class="p">)</span> <span class="c1"># save all metrics under node[&#39;chef-metrics&#39;] attribute</span>
  <span class="p">)</span>
<span class="k">end</span>
</pre></div>
<p>Example of enabling telemetry using the CLI flag</p>
<div class="highlight"><pre><span></span>chef-client --enable-telemetry
chef-solo --enable-telemetry
</pre></div>
<p>Telemetry publishing API will be a single method named #publish that accept a hash that
represents the metrics. <code>publish_using</code> method is used to register a metrics publisher
with the telemetry system.</p>

<h2>Copyright</h2>

<p>This work is in the public domain. In jurisdictions that do not allow for this,
this work is available under CC0. To the extent possible under law, the person
who associated CC0 with this work has waived all copyright and related or
neighboring rights to this work.</p>
    </div>
  </body>
</html>
