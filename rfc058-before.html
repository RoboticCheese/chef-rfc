<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable = no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation-essential/6.2.2/css/foundation.min.css">
    <style>
      a { color: #f18b21; }
      a:hover, a:focus { color: #3f5364; }
    </style>
    <title>Chef RFCs</title>
  </head>
  <body>
    <div class="row medium-12 columns">
      <header class="clearfix">
        <div class="left">
          <a href="/chef-rfc"><h1>Chef RFCs</h1></a>
        </div>
      </header>
<h1>Let users trigger another resource prior to an action happening.</h1>

<h2>Motivation</h2>
<div class="highlight"><pre><span></span>As a Chef user,
I want to make one resource action a precondition for another,
So that when two resources depend on each other, I can make an update succeed.

As a Chef user,
I want this action only to happen if the other resource *does* update,
So that I don&#39;t unnecessarily run my preconditions on every single Chef run.

As a Chef user,
I want Chef to run me an action if a resource updates,
So that I don&#39;t have to implement the resource test logic in my recipe.
</pre></div>
<h2>Specification</h2>

<p>We add a new :before timing which causes a notification to happen
<em>before</em> the resource actually updates. If the resource will not actually update,
this event does not fire.</p>

<p>The events you can specify would become:</p>

<ul>
<li>:before - before the resource updates, but <em>only</em> if an update will occur.</li>
<li>:immediately - after the resource updates, but <em>only</em> if an update occurred.</li>
<li>:delayed - after the resource updates, at the end of the run.</li>
</ul>
<div class="highlight"><pre><span></span><span class="n">package</span> <span class="s2">&quot;foo&quot;</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:upgrade</span>
  <span class="c1"># The package upgrade will fail if we try to upgrade while it runs!!!</span>
  <span class="n">notifies</span> <span class="ss">:stop</span><span class="p">,</span> <span class="s2">&quot;service[blah]&quot;</span><span class="p">,</span> <span class="ss">:before</span>
<span class="k">end</span>

<span class="n">service</span> <span class="s2">&quot;blah&quot;</span> <span class="k">do</span>
<span class="k">end</span>
</pre></div>
<p>This will work for both subscribes and notifies.</p>

<h3>Backwards Compatibility</h3>

<p>This will only affect resources which have :before on them, and will
not modify any existing resources or recipes.</p>

<h3>Implementation</h3>

<p>There is a tricky implementation detail here, because both the test (&quot;is my
package version lower than the latest?&quot;) and the set (&quot;call rpm and update the
package&quot;) part of a resource are both part of the action. Chef only runs one
action to run at a time, and it seems ill-advised to change that without a lot
of extra thinking.</p>

<p>To get around this without breaking the model, we propose that resources with an
<code>:before</code> action run a why-run test of the action and trigger off of
that, before running the action for real. The flow of this resource:</p>
<div class="highlight"><pre><span></span><span class="n">package</span> <span class="s2">&quot;foo&quot;</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:upgrade</span>
  <span class="n">notifies</span> <span class="ss">:stop</span><span class="p">,</span> <span class="s2">&quot;service[blah]&quot;</span><span class="p">,</span> <span class="ss">:before</span>
<span class="k">end</span>
</pre></div>
<p>The execution of the package upgrade looks like this:</p>

<ol>
<li>If :before events are on the resource:
a. raise an error if the resource does not support why-run.
b. Turn on why-run temporarily.
c. Run the action.
d. Send the notification if updated<em>by</em>last_action? is true.
e. Turn off why-run.</li>
<li>Run the action (for real!).</li>
<li>Send :immediate or :delayed notifications if updated<em>by</em>last_action? is true.</li>
</ol>

<h2>Copyright</h2>

<p>This work is in the public domain. In jurisdictions that do not allow for this,
this work is available under CC0. To the extent possible under law, the person
who associated CC0 with this work has waived all copyright and related or
neighboring rights to this work.</p>
    </div>
  </body>
</html>
